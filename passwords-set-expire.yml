---
- hosts: all
  vars:
    users: ['user1', 'user2']
    user_password_valid_time: 30
  tasks:
    - name: check users password valid time
      shell: getent shadow "{{ item }}" | cut -d':' -f5
      register: users_pw_valid
      with_items: users
      changed_when: False
      
    - name: set users password valid time
      shell: chage -M "{{ user_password_valid_time }}" "{{ item['item'] }}"
      with_items: users_pw_valid.results
      when: users_pw_valid.results is defined and {{ item.stdout }} != {{ user_password_valid_time }}
